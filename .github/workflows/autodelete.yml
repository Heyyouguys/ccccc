name: Cleanup lunatv â€“ keep only latest version

# ä»…æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: read          # åªè¯»ä»£ç å³å¯
      packages: read          # è¯»å–åŒ…ä¿¡æ¯ï¼ˆå®é™…åˆ é™¤ä¾èµ– PATï¼‰

    steps:
      # -------------------------------------------------
      # 1ï¸âƒ£ ä½¿ç”¨ PAT ç™»å½• ghï¼ˆå¿…é¡»æœ‰ delete:packages æƒé™ï¼‰
      - name: Authenticate gh with PAT
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token

      # -------------------------------------------------
      # 2ï¸âƒ£ è®¾å®šå¸¸é‡ï¼ˆpackage åç§°ï¼‰
      - name: Set variables
        id: vars
        run: |
          echo "PACKAGE=lunatv" >> $GITHUB_OUTPUT   # ç›®æ ‡ package åç§°ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰

      # -------------------------------------------------
      # 3ï¸âƒ£ ä¸»ä½“é€»è¾‘ï¼šè·å–å…¨éƒ¨ç‰ˆæœ¬ â†’ æ‰¾å‡ºæœ€æ–° version â†’ åˆ é™¤å…¶ä½™
      - name: Delete all but the newest version
        env:
          OWNER: ${{ github.repository_owner }}
          PACKAGE: ${{ steps.vars.outputs.PACKAGE }}
        run: |
          echo "=== Starting cleanup for $OWNER/$PACKAGE ==="

          # ---------- â‘  ç»Ÿä¸€å‡½æ•°è·å–æ‰€æœ‰ç‰ˆæœ¬ ----------
          get_versions() {
            local base=$1   # users æˆ– orgs
            gh api "/$base/$OWNER/packages/container/$PACKAGE/versions" \
              --paginate -q '[.[]]' 2>/dev/null || echo "[]"
          }

          # ---------- â‘¡ å…ˆå°è¯•ç”¨æˆ·è·¯å¾„ ----------
          VERSIONS=$(get_versions users)
          API_BASE="/users/$OWNER"

          # ---------- â‘¢ è‹¥ä¸ºç©ºï¼Œæ”¹ä¸ºç»„ç»‡è·¯å¾„ ----------
          if [ "$VERSIONS" = "[]" ]; then
            echo "User path returned empty â€“ trying organization path"
            VERSIONS=$(get_versions orgs)
            API_BASE="/orgs/$OWNER"
          fi

          # ---------- â‘£ æ£€æŸ¥è¿”å›çš„ JSON æ˜¯å¦æœ‰æ•ˆ ----------
          if ! echo "$VERSIONS" | jq . >/dev/null 2>&1; then
            echo "âŒ Failed to parse JSON from GitHub API â€“ abort"
            exit 1
          fi

          TOTAL=$(echo "$VERSIONS" | jq 'length')
          echo "Found $TOTAL version(s) in the package"

          if [ "$TOTAL" -le 1 ]; then
            echo "Only $TOTAL version(s) â€“ nothing to delete"
            exit 0
          fi

          # ---------- â‘¤ æ‰¾å‡ºæœ€æ–°çš„ version ----------
          # è¿™é‡Œä½¿ç”¨ created_atï¼ˆISO8601ï¼‰ï¼Œå–æœ€å¤§æ—¶é—´å³ä¸ºæœ€æ–°
          LATEST_ID=$(echo "$VERSIONS" |
            jq -r 'sort_by(.created_at) | last | .id')
          echo "Latest version ID (to keep): $LATEST_ID"

          # ---------- â‘¥ è¿‡æ»¤å‡ºæ‰€æœ‰ **éæœ€æ–°** çš„ version IDs ----------
          TO_DELETE=$(echo "$VERSIONS" |
            jq -r --arg keep "$LATEST_ID" '.[] | select(.id != $keep) | .id')
          DELETE_COUNT=$(echo "$TO_DELETE" | grep -c . || echo 0)
          echo "ğŸ—‘ï¸  $DELETE_COUNT version(s) will be removed (all except the newest)"

          if [ "$DELETE_COUNT" -eq 0 ]; then
            echo "Nothing to delete"
            exit 0
          fi

          # ---------- â‘¦ åˆ é™¤ ----------
          echo "$TO_DELETE" | while read -r id; do
            echo "Deleting version $id ..."
            gh api -X DELETE "$API_BASE/packages/container/$PACKAGE/versions/$id" \
              && echo "  âœ… deleted" \
              || echo "  âŒ delete failed (status $?)"
          done

          echo "=== Cleanup finished ==="
