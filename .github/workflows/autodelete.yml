name: Cleanup Untagged Versions

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete all untagged package versions
        env:
          GH_TOKEN: ${{ secrets.PAT }}
          OWNER: ${{ github.repository_owner }}
          PACKAGE: ${{ github.event.repository.name }}
        run: |
          echo "Cleaning up untagged versions for $OWNER/$PACKAGE"
          
          # 尝试 user 路径
          VERSIONS=$(gh api /users/$OWNER/packages/container/$PACKAGE/versions --paginate 2>/dev/null || echo "[]")
          
          # 如果失败，尝试 org 路径
          if [ "$VERSIONS" = "[]" ]; then
            echo "Trying org path..."
            VERSIONS=$(gh api /orgs/$OWNER/packages/container/$PACKAGE/versions --paginate 2>/dev/null || echo "[]")
            API_BASE="/orgs/$OWNER"
          else
            API_BASE="/users/$OWNER"
          fi
          
          # 统计总数
          TOTAL=$(echo "$VERSIONS" | jq 'length')
          echo "Found $TOTAL total version(s)"
          
          # 找出所有 untagged 版本（tags 数组为空的）
          UNTAGGED=$(echo "$VERSIONS" | jq -r '.[] | select(.metadata.container.tags | length == 0) | .id')
          UNTAGGED_COUNT=$(echo "$UNTAGGED" | grep -c . || echo 0)
          
          echo "Found $UNTAGGED_COUNT untagged version(s) to delete"
          
          if [ "$UNTAGGED_COUNT" -eq 0 ]; then
            echo "No untagged versions to delete"
            exit 0
          fi
          
          # 删除所有 untagged 版本
          echo "$UNTAGGED" | while read -r id; do
            if [ -n "$id" ]; then
              echo "Deleting untagged version: $id"
              gh api -X DELETE "$API_BASE/packages/container/$PACKAGE/versions/$id" \
                && echo "  ✓ Deleted" \
                || echo "  ✗ Failed"
            fi
          done
          
          echo "Cleanup completed!"
