name: Cleanup Old Versions

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # 每天凌晨2点运行

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup old workflow runs
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.PAT }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1

      - name: Cleanup old package versions
        env:
          GH_TOKEN: ${{ secrets.PAT }}
          OWNER: ${{ github.repository_owner }}
          PACKAGE: ${{ github.event.repository.name }}
        run: |
          echo "Fetching package versions for $OWNER/$PACKAGE"
          
          # 尝试 user 路径
          VERSIONS=$(gh api /users/$OWNER/packages/container/$PACKAGE/versions --jq 'sort_by(.created_at) | reverse' 2>/dev/null || echo "[]")
          
          # 如果失败，尝试 org 路径
          if [ "$VERSIONS" = "[]" ]; then
            echo "Trying org path..."
            VERSIONS=$(gh api /orgs/$OWNER/packages/container/$PACKAGE/versions --jq 'sort_by(.created_at) | reverse' 2>/dev/null || echo "[]")
            API_BASE="/orgs/$OWNER"
          else
            API_BASE="/users/$OWNER"
          fi
          
          TOTAL=$(echo "$VERSIONS" | jq 'length')
          echo "Found $TOTAL version(s)"
          
          if [ "$TOTAL" -le 1 ]; then
            echo "Nothing to delete"
            exit 0
          fi
          
          LATEST=$(echo "$VERSIONS" | jq -r '.[0].id')
          echo "Keeping latest: $LATEST"
          
          echo "$VERSIONS" | jq -r '.[1:] | .[].id' | while read id; do
            echo "Deleting version $id..."
            gh api -X DELETE "$API_BASE/packages/container/$PACKAGE/versions/$id" && echo "  ✓ Deleted" || echo "  ✗ Failed"
          done
          
          echo "Cleanup completed!"
