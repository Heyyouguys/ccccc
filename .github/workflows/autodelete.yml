name: Cleanup Untagged Versions

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'   # ÊØèÂ§© 02:00 UTC

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: read         # ËØªÂèñ‰ª£Á†Å
      packages: write        # ËØªÂèñ/ÂÜôÂÖ•ÂåÖ
      # Ê≥®ÊÑèÔºöÂç≥‰ΩøËøôÈáåÂÜô writeÔºå‰πü‰∏çÂ§üÂà†Èô§ÔºåÈúÄË¶Å PAT

    steps:
      # 1Ô∏è‚É£ ËÆ© gh ‰ΩøÁî® PAT
      - name: Authenticate gh
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token

      # 2Ô∏è‚É£ ‰∏ªÈÄªËæë
      - name: Delete all untagged package versions
        env:
          OWNER: ${{ github.repository_owner }}
          PACKAGE: ${{ github.event.repository.name }}
        run: |
          echo "=== Start cleanup for $OWNER/$PACKAGE ==="

          # ---- ÂèñÁâàÊú¨ÔºàÂÖà userÔºåÂêé orgÔºâ----
          get_versions() {
            local base=$1   # users Êàñ orgs
            gh api "/$base/$OWNER/packages/container/$PACKAGE/versions" \
              --paginate -q '[.[]]' 2>/dev/null || echo "[]"
          }

          VERSIONS=$(get_versions users)
          API_BASE="/users/$OWNER"

          if [ "$VERSIONS" = "[]" ]; then
            echo "User path empty ‚Üí try org path"
            VERSIONS=$(get_versions orgs)
            API_BASE="/orgs/$OWNER"
          fi

          # ---- Ê£ÄÊü•ËøîÂõûÊòØÂê¶ÊúâÊïà ----
          if ! echo "$VERSIONS" | jq . >/dev/null 2>&1; then
            echo "‚ùå Failed to parse JSON, abort"
            exit 1
          fi

          TOTAL=$(echo "$VERSIONS" | jq 'length')
          echo "Found $TOTAL total version(s)"

          # ---- ËøáÊª§Âá∫ untagged ----
          UNTAGGED=$(echo "$VERSIONS" |
            jq -r '.[] |
              select(.metadata?.container?.tags | length == 0) |
              .id')
          UNTAGGED_COUNT=$(echo "$UNTAGGED" | grep -c . || echo 0)
          echo "üóëÔ∏è  $UNTAGGED_COUNT untagged version(s) will be removed"

          if [ "$UNTAGGED_COUNT" -eq 0 ]; then
            echo "Nothing to delete ‚Äì all versions have tags"
            exit 0
          fi

          # ---- Âà†Èô§ ----
          echo "$UNTAGGED" | while read -r id; do
            echo "Deleting version $id ..."
            gh api -X DELETE "$API_BASE/packages/container/$PACKAGE/versions/$id" \
              && echo "  ‚úÖ deleted" \
              || echo "  ‚ùå delete failed (status $?)"
          done

          echo "=== Cleanup finished ==="
