      - name: Cleanup old package versions
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
          REPO: ${{ github.repository }}
        run: |
          python3 << 'EOF'
          import requests
          import os
          import sys
          
          token = os.environ.get('GITHUB_TOKEN')
          repo_full = os.environ.get('REPO')
          
          if not token or not repo_full:
              print('Error: Missing environment variables')
              sys.exit(1)
          
          owner, repo_name = repo_full.split('/')
          print(f'Repository: {owner}/{repo_name}')
          
          headers = {
              'Accept': 'application/vnd.github+json',
              'Authorization': f'token {token}',
              'X-GitHub-Api-Version': '2022-11-28'
          }
          
          user_url = f'https://api.github.com/users/{owner}/packages/container/{repo_name}/versions'
          org_url = f'https://api.github.com/orgs/{owner}/packages/container/{repo_name}/versions'
          
          success_url = None
          
          r = requests.get(user_url, headers=headers)
          if r.status_code == 200:
              success_url = user_url
              print('Using user path')
          else:
              r = requests.get(org_url, headers=headers)
              if r.status_code == 200:
                  success_url = org_url
                  print('Using org path')
          
          if not success_url:
              print('Failed to access package versions')
              sys.exit(1)
          
          versions = requests.get(success_url, headers=headers).json()
          if not versions:
              print('No versions found')
              sys.exit(0)
          
          sorted_versions = sorted(versions, key=lambda x: x.get('created_at', ''), reverse=True)
          print(f'Found {len(sorted_versions)} versions')
          
          if len(sorted_versions) <= 1:
              print('Nothing to delete')
              sys.exit(0)
          
          latest = sorted_versions[0]
          print(f'Keeping latest: {latest.get("id")} ({latest.get("created_at")})')
          
          deleted_count = 0
          for version in sorted_versions[1:]:
              vid = version.get('id')
              print(f'Deleting version {vid}...')
              resp = requests.delete(f'{success_url}/{vid}', headers=headers)
              if resp.status_code == 204:
                  deleted_count += 1
                  print('  Deleted')
              else:
                  print(f'  Failed: {resp.status_code}')
          
          print(f'Complete: Deleted {deleted_count} old versions, kept 1 latest')
          EOF
