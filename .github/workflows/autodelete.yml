name: Cleanup lunatv â€“ Untagged >10d

# æ‰‹åŠ¨è§¦å‘æˆ–æ¯å¤©å‡Œæ™¨ 2 ç‚¹ï¼ˆUTCï¼‰è¿è¡Œ
on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'   # æ¯å¤© 02:00 UTC

jobs:
  cleanup:
    runs-on: ubuntu-latest
    # åªéœ€è¦è¯»å–ä»£ç å’ŒåŒ…çš„æƒé™ï¼›çœŸæ­£çš„åˆ é™¤ä¾èµ– PAT
    permissions:
      contents: read
      packages: read

    steps:
      # -------------------------------------------------
      # 1ï¸âƒ£ ä½¿ç”¨ PAT ç™»å½• ghï¼ˆå¿…é¡»æœ‰ delete:packagesï¼‰
      - name: Authenticate gh with PAT
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          # å°† token ç›´æ¥å–‚ç»™ gh
          echo "$GH_TOKEN" | gh auth login --with-token

      # -------------------------------------------------
      # 2ï¸âƒ£ è®¾å®šå¸¸é‡
      - name: Set variables
        id: vars
        run: |
          echo "PACKAGE= lunatv" >> $GITHUB_OUTPUT   # å¾…æ¸…ç†çš„ package åç§°
          # 10 å¤©å‰çš„æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
          echo "CUT_OFF=$(date -d '-10 days' +%s)" >> $GITHUB_OUTPUT
          # å½“å‰æ—¶é—´æˆ³ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "NOW=$(date +%s)" >> $GITHUB_OUTPUT

      # -------------------------------------------------
      # 3ï¸âƒ£ ä¸»ä½“é€»è¾‘ï¼šè·å–ç‰ˆæœ¬ â†’ è¿‡æ»¤ â†’ åˆ é™¤
      - name: Delete untagged versions older than 10 days
        env:
          OWNER: ${{ github.repository_owner }}
          PACKAGE: ${{ steps.vars.outputs.PACKAGE }}
          CUT_OFF: ${{ steps.vars.outputs.CUT_OFF }}
          NOW: ${{ steps.vars.outputs.NOW }}
        run: |
          echo "=== Cleanup for $OWNER/$PACKAGE ==="
          echo "Cutâ€‘off timestamp (10d ago): $CUT_OFF"
          echo "Current timestamp: $NOW"

          # ---------- â‘  ç»Ÿä¸€å‡½æ•°è·å–æ‰€æœ‰ç‰ˆæœ¬ ----------
          get_versions() {
            local base=$1   # users æˆ– orgs
            gh api "/$base/$OWNER/packages/container/$PACKAGE/versions" \
              --paginate -q '[.[]]' 2>/dev/null || echo "[]"
          }

          # ---------- â‘¡ å…ˆå°è¯•ç”¨æˆ·è·¯å¾„ ----------
          VERSIONS=$(get_versions users)
          API_BASE="/users/$OWNER"

          # ---------- â‘¢ è‹¥ä¸ºç©ºï¼Œæ”¹ä¸ºç»„ç»‡è·¯å¾„ ----------
          if [ "$VERSIONS" = "[]" ]; then
            echo "User path empty â†’ trying org path"
            VERSIONS=$(get_versions orgs)
            API_BASE="/orgs/$OWNER"
          fi

          # ---------- â‘£ æ£€æŸ¥è¿”å›æ˜¯å¦åˆæ³• ----------
          if ! echo "$VERSIONS" | jq . >/dev/null 2>&1; then
            echo "âŒ Failed to parse JSON from API â€“ abort"
            exit 1
          fi

          TOTAL=$(echo "$VERSIONS" | jq 'length')
          echo "Found $TOTAL total version(s) in the package"

          # ---------- â‘¤ è¿‡æ»¤å‡ºæ»¡è¶³æ¡ä»¶çš„ç‰ˆæœ¬ ----------
          # æ¡ä»¶ï¼šâ‘  tags æ•°ç»„ä¸ºç©º   â‘¡ created_at æ—©äº cutâ€‘off
          UNTAGGED_OLD=$(echo "$VERSIONS" |
            jq -r --argjson cutoff "$CUT_OFF" '
              .[] |
              select(.metadata?.container?.tags | length == 0) |   # æ²¡æœ‰ tag
              select((.created_at | fromdate) < $cutoff) |      # è¶…è¿‡ 10 å¤©
              .id')
          COUNT=$(echo "$UNTAGGED_OLD" | grep -c . || echo 0)
          echo "ğŸ—‘ï¸  $COUNT untagged version(s) older than 10 days will be deleted"

          if [ "$COUNT" -eq 0 ]; then
            echo "Nothing to delete â€“ all untagged versions are fresh"
            exit 0
          fi

          # ---------- â‘¥ å®é™…åˆ é™¤ ----------
          echo "$UNTAGGED_OLD" | while read -r id; do
            echo "Deleting version $id ..."
            gh api -X DELETE "$API_BASE/packages/container/$PACKAGE/versions/$id" \
              && echo "  âœ… deleted" \
              || echo "  âŒ delete failed (status $?)"
          done

          echo "=== Cleanup finished ==="
