name: Cleanup lunatv â€“ keep recent versions

# åªéœ€è¦æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: read          # åªè¯»ä»£ç 
      packages: read          # è¯»å–åŒ…ä¿¡æ¯ï¼ˆå®é™…åˆ é™¤é  PATï¼‰

    steps:
      # -------------------------------------------------
      # 1ï¸âƒ£ ç”¨æ‹¥æœ‰ delete:packages æƒé™çš„ PAT ç™»å½• gh
      - name: Authenticate gh with PAT
        env:
          GH_TOKEN: ${{ secrets.PAT }}   # <â€‘â€‘ å¿…é¡»æ˜¯å¸¦ delete:packages çš„ PAT
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token

      # -------------------------------------------------
      # 2ï¸âƒ£ é…ç½®å¸¸é‡
      - name: Set variables
        id: vars
        run: |
          # ---- ç›®æ ‡ package åç§°ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰----
          echo "PACKAGE=lunatv" >> $GITHUB_OUTPUT

          # ---- ä¿ç•™é˜ˆå€¼ï¼šè¿™é‡Œè®¾ä¸º 10 åˆ†é’Ÿï¼ˆ600 ç§’ï¼‰----
          # è‹¥æƒ³æ”¹æˆå¤©æ•°ï¼Œåªéœ€è¦æŠŠä¸‹é¢çš„ -d å‚æ•°æ”¹æˆ '-10 days'
          echo "CUT_OFF=$(date -d '-10 minutes' +%s)" >> $GITHUB_OUTPUT

          # ---- å½“å‰æ—¶é—´ï¼ˆç”¨äºè°ƒè¯•ï¼‰----
          echo "NOW=$(date +%s)" >> $GITHUB_OUTPUT

      # -------------------------------------------------
      # 3ï¸âƒ£ ä¸»ä½“ï¼šè·å–æ‰€æœ‰ç‰ˆæœ¬ â†’ è¿‡æ»¤ï¼ˆä»…ä¿ç•™æœ€è¿‘ï¼‰ â†’ åˆ é™¤å…¶ä½™
      - name: Delete old untagged/old versions
        env:
          OWNER: ${{ github.repository_owner }}
          PACKAGE: ${{ steps.vars.outputs.PACKAGE }}
          CUT_OFF: ${{ steps.vars.outputs.CUT_OFF }}
          NOW: ${{ steps.vars.outputs.NOW }}
        run: |
          echo "=== Cleanup for $OWNER/$PACKAGE ==="
          echo "Current timestamp (NOW)      : $NOW"
          echo "Cutâ€‘off timestamp (keep â‰¥)    : $CUT_OFF  (â‰ˆ $(date -d @$CUT_OFF))"

          # ---------- â‘  ç»Ÿä¸€å‡½æ•°è·å–æ‰€æœ‰ç‰ˆæœ¬ ----------
          get_versions() {
            local base=$1   # users æˆ– orgs
            gh api "/$base/$OWNER/packages/container/$PACKAGE/versions" \
              --paginate -q '[.[]]' 2>/dev/null || echo "[]"
          }

          # ---------- â‘¡ å…ˆå°è¯•ç”¨æˆ·è·¯å¾„ ----------
          VERSIONS=$(get_versions users)
          API_BASE="/users/$OWNER"

          # ---------- â‘¢ è‹¥ä¸ºç©ºï¼Œæ”¹ä¸ºç»„ç»‡è·¯å¾„ ----------
          if [ "$VERSIONS" = "[]" ]; then
            echo "User path empty â†’ trying organization path"
            VERSIONS=$(get_versions orgs)
            API_BASE="/orgs/$OWNER"
          fi

          # ---------- â‘£ æ£€æŸ¥è¿”å›æ˜¯å¦åˆæ³• ----------
          if ! echo "$VERSIONS" | jq . >/dev/null 2>&1; then
            echo "âŒ Failed to parse JSON from GitHub API â€“ abort"
            exit 1
          fi

          TOTAL=$(echo "$VERSIONS" | jq 'length')
          echo "Found $TOTAL version(s) in the package"

          if [ "$TOTAL" -le 1 ]; then
            echo "Only $TOTAL version(s) â€“ nothing to delete"
            exit 0
          fi

          # ---------- â‘¤ è¿‡æ»¤å‡º **éœ€è¦åˆ é™¤** çš„ç‰ˆæœ¬ ----------
          # æ¡ä»¶ï¼š
          #   1. created_at æ—©äº CUT_OFFï¼ˆå³å¤ªæ—§ï¼‰
          #   2. ï¼ˆå¯é€‰ï¼‰å¦‚æœä½ åªæƒ³ä¿ç•™ *æœªæ‰“ tag* çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¯å†åŠ ä¸Š tags è¿‡æ»¤ï¼›
          #      è¿™é‡Œæˆ‘ä»¬åªä¾æ®æ—¶é—´ï¼Œä¸ç®¡æœ‰æ²¡æœ‰ tagã€‚
          TO_DELETE=$(echo "$VERSIONS" |
            jq -r --argjson cutoff "$CUT_OFF" '
              .[] |
              select((.created_at | fromdate) < $cutoff) |
              .id')
          DELETE_COUNT=$(echo "$TO_DELETE" | grep -c . || echo 0)
          echo "ğŸ—‘ï¸  $DELETE_COUNT version(s) older than the cutâ€‘off will be removed"

          if [ "$DELETE_COUNT" -eq 0 ]; then
            echo "No old versions to delete"
            exit 0
          fi

          # ---------- â‘¥ å®é™…åˆ é™¤ ----------
          echo "$TO_DELETE" | while read -r id; do
            echo "Deleting version $id ..."
            gh api -X DELETE "$API_BASE/packages/container/$PACKAGE/versions/$id" \
              && echo "  âœ… deleted" \
              || echo "  âŒ delete failed (status $?)"
          done

          echo "=== Cleanup finished ==="
