name: Retain Latest Package Version

on:
  schedule:
    - cron: '0 0 * * *'  # 每天午夜运行
  workflow_dispatch:
    inputs:
      package_type:
        description: 'Package type (e.g., container, npm, maven)'
        required: true
        default: 'container'

jobs:
  cleanup-packages:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Retain latest package version
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        REPO: ${{ github.repository }}
        PACKAGE_TYPE: ${{ github.event.inputs.package_type || 'container' }}
      run: |
        python - <<EOF
        import requests
        import os
        from datetime import datetime

        owner, repo = os.environ['REPO'].split('/')
        package_type = os.environ['PACKAGE_TYPE']
        token = os.environ['GITHUB_TOKEN']

        api_url = f"https://api.github.com/user/packages/{package_type}/{repo}/versions"

        headers = {
            "Accept": "application/vnd.github+json",
            "Authorization": f"token {token}",
            "X-GitHub-Api-Version": "2022-11-28"
        }

        response = requests.get(api_url, headers=headers)
        versions = response.json()

        # 按创建时间排序版本
        sorted_versions = sorted(versions, key=lambda x: datetime.strptime(x['created_at'], "%Y-%m-%dT%H:%M:%SZ"), reverse=True)

        # 保留最新版本
        latest_version = sorted_versions[0]
        print(f"Keeping latest version: {latest_version['id']}")

        # 删除其他版本
        for version in sorted_versions[1:]:
            version_id = version['id']
            delete_url = f"{api_url}/{version_id}"
            delete_response = requests.delete(delete_url, headers=headers)
            if delete_response.status_code == 204:
                print(f"Successfully deleted package version {version_id}")
            else:
                print(f"Failed to delete package version {version_id}")

        print("Cleanup process completed.")
        EOF
